#!/bin/csh
# Usage: script rate log_number
# Script to use the logfiles generated by genlog.
# and files generated by genfiles
# NOTE: assumes userver is started in src directory
# The only option is the logfile number to use.
# E.g., files generated are:
#     logfile-1 requests-1
#     logfile-2 requests-2
#     logfile-3 requests-3
#     logfile-4 requests-4
# The logfile-* files contains the log of requests to generate
# while the requests-* file contain the number of requests
# files/requests contained in each of the files.

# Some basic configuration
set show_replies = 0
set server      = "127.0.0.1"

if ($#argv != 2) then
  echo "Usage : $0 rate log_number"
  exit 1
endif

set rate           = "--rate $1"
set num_requests   = `cat requests-$2`
set logfile        = logfile-$2

echo "Using log number = $2"
echo "Using logfile = $logfile"
echo "Using rate = $1"


set uselog      = "--wlog n,$logfile"
set conns       = "--num-conns $num_requests"

# Request 10 byte file (assume userver is started in src dir)
set uri         = ""
set httperf     = "httperf"
set httpversion = "--http-version 1.1"
set timeout     = "--timeout 3"
set port        = "--port 6800"
set extraopts   = "--verbose --hog --rate-interval 1"

if ($show_replies) then
  set print = "--print-reply"
else
  set print = ""
endif

$httperf $extraopts --server $server $port $httpversion \
         $conns $timeout $print $rate $uselog

exit $status
